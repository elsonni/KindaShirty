<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Checkout | KindaShirty</title>
  <link rel="stylesheet" href="/css/style.css"/>
  <link rel="preconnect" href="https://rsms.me" crossorigin>
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css"/>
  <script src="https://web.squarecdn.com/v1/square.js" type="text/javascript"></script>
  <style>
    :root {
      --square-blue: #006aff;
      --gray-light: #f5f7f9;
      --gray-border: #e1e4e8;
      --font-primary: 'Inter', sans-serif;
    }
    body { font-family: var(--font-primary); background: var(--gray-light); color: #111; margin: 0; }
    .checkout-container { max-width: 800px; margin: 4rem auto; padding: 2rem; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .checkout-container h1, h2 { font-weight: 700; color: #111; }
    .checkout-container label { display: block; margin-top: 1rem; font-weight: 600; }
    .checkout-container input {
      width: 100%; padding: 0.75rem; margin-top: 0.25rem; border: 1px solid var(--gray-border);
      border-radius: 6px; font-family: var(--font-primary); font-size: 1.05rem;
    }
    #summary { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ddd; }
    #summary p { margin: 0.25rem 0; }
    #card-container { margin-top: 2rem; }
    #pay-button {
      margin-top: 2rem; width: 100%; padding: 0.75rem; background: var(--square-blue); color: #fff; font-size: 1rem;
      font-weight: 600; text-transform: uppercase; border: none; border-radius: 6px; cursor: pointer; transition: background .3s ease;
    }
    #pay-button:hover { background: #0051cc; }
    #status { margin-top: 1rem; color: red; }
    .square-footer { margin-top: 2rem; font-size: .875rem; text-align: center; color: #555; }
    .square-footer p { margin-top: 1rem; }
    .square-footer a { color: var(--square-blue); text-decoration: underline; }
    .promo-row { display:flex; gap:.5rem; align-items:center; margin-top: .75rem; }
    .promo-row input { flex: 1 1 auto; }
  </style>
</head>
<body>
  <div data-include="/partials/header.html"></div>

  <div style="text-align:center; margin-top:2rem;">
    <img src="img/logos/checkout.png" alt="KindaShirty Logo" style="height:200px; max-width:200px;"/>
  </div>

  <div class="checkout-container">
    <h1 class="page-title">Secure Checkout</h1>

    <form id="checkout-form" novalidate>
      <h2>Contact</h2>
      <label>Email
        <input type="email" name="email" required />
      </label>

      <h2>Delivery</h2>
      <label>First name
        <input type="text" name="firstName" />
      </label>
      <label>Last name
        <input type="text" name="name" required />
      </label>
      <label>Company (optional)
        <input type="text" name="company" />
      </label>
      <label>Address
        <input type="text" name="address" required />
      </label>
      <label>Apartment, suite, etc. (optional)
        <input type="text" name="address2" />
      </label>
      <label>City
        <input type="text" name="city" required />
      </label>
      <label>State
        <input type="text" name="state" required />
      </label>
      <label>ZIP Code
        <input type="text" name="zip" required />
      </label>
      <label>Phone (optional)
        <input type="tel" name="phone" />
      </label>

      <div id="summary">
        <p>Subtotal: <strong id="subtotal">$0.00</strong></p>

        <!-- Promo UI -->
        <div class="promo-row">
          <input id="promoInput" type="text" placeholder="Promo code (optional)" aria-label="Promo code">
          <button type="button" id="applyPromo" style="padding:.6rem 1rem;">Apply</button>
        </div>
        <small id="promoStatus" style="color:#666;"></small>

        <p id="discountRow" style="display:none;">Promo Discount: <strong id="discountAmount">-$0.00</strong></p>

        <p>Estimated Tax: <strong id="tax">$0.00</strong></p>
        <small id="tax-note" style="color:#666;">Enter your state & ZIP to see tax and shipping.</small>

        <p>Shipping: <strong id="shipping">$0.00</strong></p>
        <small style="color:#666;">Standard (10â€“14 Days)<br/>Time includes creating + shipping combined.</small>

        <p><strong>Total: <span id="total">$0.00</span></strong></p>
      </div>

      <div id="card-container"></div>
      <button id="pay-button" type="button">ðŸ”’ Pay Now</button>
      <div id="status"></div>
    </form>

    <div class="square-footer">
      Payments securely processed by <strong>Square</strong>.
      <p>
        Your information may be saved to a Square Pay account. By continuing, you agree to Squareâ€™s
        <a href="https://squareup.com/us/en/legal/general/square-pay-tos" target="_blank" rel="noopener">Terms of Service</a>
        and acknowledge the
        <a href="https://squareup.com/us/en/legal/general/privacy" target="_blank" rel="noopener">Privacy Policy</a>.
      </p>
    </div>
  </div>

  <div data-include="/partials/footer.html"></div>

  <script>
    // --- Square + config ---
    const SQUARE_APP_ID = 'sq0idp-48V9iV3gOtsCmqKaVnAQGg';
    const SQUARE_LOCATION_ID = 'L2D48TBFREJVA';

    // --- Cart helpers ---
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    function calculateLocalSubtotal() {
      return cart.reduce((sum, item) => sum + parseFloat(String(item.price).replace('$','')) * (parseInt(item.quantity) || 0), 0);
    }
    const formatMoney = n => `$${(Number(n)||0).toFixed(2)}`;

    // --- Promo state ---
    let appliedPromo = null;
    let promoDiscountRate = 0; // percent
    let lastStateInput = '', lastZipInput = '';

    // --- Square Web Payments: card form ---
    let payments, card;
    async function initializeCardForm() {
      try {
        payments = Square.payments(SQUARE_APP_ID, SQUARE_LOCATION_ID);
        card = await payments.card();
        await card.attach('#card-container');
      } catch (err) {
        document.getElementById('status').textContent = 'Failed to load payment form.';
        console.error(err);
      }
    }
    async function tokenizeCard() {
      const result = await card.tokenize();
      if (result.status === 'OK') return result.token;
      throw new Error(result.errors?.[0]?.message || 'Card error');
    }

    // --- Live totals via Netlify calc function (Option B) ---
    async function fetchTotalsFromServer(state, email) {
      const body = JSON.stringify({
        cart,
        state,
        promoPercent: promoDiscountRate || 0,
        promoCode: appliedPromo || null,
        email: email || null
      });
      const res = await fetch('/.netlify/functions/calc-totals', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Totals calculation failed');
      return data; // {isCA, itemsGross, discount, shipping, tax, total}
    }

    async function updateSummaryDisplay(state = '', zip = '') {
      const emailVal = document.querySelector('input[name="email"]')?.value?.trim() || '';
      const hasAddress = state.trim().length > 1 && (zip.trim().length >= 5);

      let itemsGross = calculateLocalSubtotal();
      let discount = 0, shipping = 0, tax = 0, total = itemsGross;

      if (hasAddress && cart.length) {
        try {
          const data = await fetchTotalsFromServer(state, emailVal);
          window.__lastCalc = data;
          itemsGross = Number(data.itemsGross ?? itemsGross);
          discount   = Number(data.discount ?? 0);
          shipping   = Number(data.shipping ?? 0);
          tax        = Number(data.tax ?? 0);
          total      = Number(data.total ?? (itemsGross - discount + shipping + tax));
        } catch (e) {
          console.warn('Totals calc fallback (local):', e);
          // Leave local subtotal; shipping/tax 0 as a fallback

        }
      }

      // Render
      document.getElementById('subtotal').textContent      = formatMoney(itemsGross);
      document.getElementById('tax').textContent           = formatMoney(tax);
      document.getElementById('shipping').textContent      = formatMoney(shipping);
      document.getElementById('total').textContent         = formatMoney(total);

      const discountRow = document.getElementById('discountRow');
      const discountAmountEl = document.getElementById('discountAmount');
      if (discountRow && discountAmountEl) {
        if (discount > 0) {
          discountAmountEl.textContent = `-$${discount.toFixed(2)}`;
          discountRow.style.display = 'block';
        } else {
          discountRow.style.display = 'none';
        }
      }

      const note = document.getElementById('tax-note');
      if (note) {
        if (!hasAddress) note.textContent = 'Enter your state & ZIP to see tax and shipping.';
        else note.textContent = (window.__lastCalc?.isCA ? 'CA sales tax applies (calculated by Square).' : 'No sales tax for this destination.');
      }

      return { estimatedTax: tax, total, shipping, discount };
    }

    // --- Promo code (validate via server and refresh totals) ---
    document.getElementById('applyPromo')?.addEventListener('click', async () => {
      const promoCode = document.getElementById('promoInput')?.value.trim();
      const statusEl  = document.getElementById('promoStatus');
      const email = document.querySelector('input[name="email"]')?.value.trim().toLowerCase();
      const stateInput = document.querySelector('input[name="state"]')?.value.trim();
      const zipInput   = document.querySelector('input[name="zip"]')?.value.trim();

      if (!promoCode) { statusEl.textContent = 'Please enter a promo code.'; return; }
      if (!email || !stateInput || !zipInput) {
        statusEl.textContent = 'Enter email, state, and ZIP before applying a code.'; return;
      }

      lastStateInput = stateInput; lastZipInput = zipInput;

      try {
        const res = await fetch('/.netlify/functions/check-promo?code=' + encodeURIComponent(promoCode) + '&email=' + encodeURIComponent(email));
        const result = await res.json();
        if (res.ok && result.valid) {
          appliedPromo = promoCode;
          promoDiscountRate = Number(result.amount || 0);
          statusEl.textContent = `Applied: ${promoDiscountRate}% off`;
        } else {
          appliedPromo = null; promoDiscountRate = 0;
          statusEl.textContent = result.error || 'Invalid promo code.';
        }
      } catch (err) {
        appliedPromo = null; promoDiscountRate = 0;
        console.error('Promo check error:', err);
        statusEl.textContent = 'Error validating code.';
      }

      await updateSummaryDisplay(lastStateInput, lastZipInput);
    });

    // --- Pay button ---
    document.getElementById('pay-button').addEventListener('click', async () => {
      const form = document.getElementById('checkout-form');
      const statusEl = document.getElementById('status');
      statusEl.textContent = '';

      // simple validation
      form.querySelectorAll('input').forEach(input => input.style.borderColor = '');
      let firstError = null;
      ['name','email','address','city','state','zip'].forEach(field => {
        const input = form.querySelector(`[name="${field}"]`);
        if (!input || !input.value.trim() || (field === 'email' && !input.value.includes('@'))) {
          input.style.borderColor = 'red';
          if (!firstError) firstError = input;
        }
      });
      if (firstError) {
        statusEl.textContent = 'Please complete all required fields.';
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstError.focus();
        return;
      }

      const formData = Object.fromEntries(new FormData(form).entries());
      const { estimatedTax, total, shipping } = await updateSummaryDisplay(formData.state, formData.zip);

      try {
        const token = await tokenizeCard();

        const payload = {
          token,
          cart,
          customer: {
            name: formData.name,
            email: formData.email,
            address: formData.address,
            city: formData.city,
            state: formData.state,
            zip: formData.zip,
            firstName: formData.firstName,
            company: formData.company,
            address2: formData.address2,
            phone: formData.phone
          },
          // mirror preview inputs so server can apply the same logic
          shipping,
          total: Number(parseFloat(total).toFixed(2)),
          estimatedTax: Number(parseFloat(estimatedTax).toFixed(2)),
          promoPercent: promoDiscountRate || 0,
          promoCode: appliedPromo || null
        };

        const res = await fetch('/.netlify/functions/charge-full-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();

        if (res.ok && result.success) {
          // Store summary for thank-you page
          const checkoutResult = {
            referenceId: result.referenceId,
            orderId: result.orderId,
            paymentId: result.paymentId,
            receiptUrl: result.receiptUrl || null,
            items: cart,
            tax: (result.taxAmount || 0) / 100,
            shipping: result.shipping || shipping,
            discount: result.discount || 0,
            total: result.total || total
          };
          localStorage.setItem('checkoutResult', JSON.stringify(checkoutResult));

          // Clear cart and go
          localStorage.removeItem('cart');
          window.location.href = '/thank-you.html';
        } else {
          throw new Error(result.error || 'Payment failed.');
        }
      } catch (err) {
        statusEl.textContent = err.message;
        console.error(err);
      }
    });

    // --- Boot ---
    document.addEventListener('DOMContentLoaded', () => {
      const stateInput = document.querySelector('input[name="state"]');
      const zipInput   = document.querySelector('input[name="zip"]');

      async function refreshSummary() {
        await updateSummaryDisplay(stateInput?.value || '', zipInput?.value || '');
      }
      if (stateInput) stateInput.addEventListener('input', refreshSummary);
      if (zipInput)   zipInput.addEventListener('input', refreshSummary);

      refreshSummary();
      initializeCardForm();
    });

    // Load header/footer partials
    document.querySelectorAll('[data-include]').forEach(el => {
      fetch(el.getAttribute('data-include'))
        .then(res => res.text())
        .then(html => { el.innerHTML = html; });
    });
  </script>
</body>
</html>
